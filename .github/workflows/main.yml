name: HiHello Publish

# タグ push でも、手動起動でも実行可能
on:
  workflow_dispatch: {}       # 手動起動
  push:
    tags:
      - 'v*'                 # v0.1.1 のようなタグ push でも実行

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      # コード取得
      - name: Checkout repository
        uses: actions/checkout@v3

      # Python 3.11 環境
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # pip 更新 & ビルド/テストツール導入
      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build twine pytest

      # dist/ クリーン（古いビルド削除）
      - name: Clean dist directory
        run: rm -rf dist/*

      # ライブラリを editable モードでインストール
      - name: Install HiHello
        run: pip install -e .

      # PYTHONPATH 設定して pytest 実行
      - name: Run tests
        working-directory: ${{ github.workspace }}
        run: |
          export PYTHONPATH=$PYTHONPATH:${GITHUB_WORKSPACE}
          pytest tests/ -v

      # パッケージビルド
      - name: Build package
        run: python -m build

      # PyPI へ公開
      - name: Publish to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_KEY }}
        run: python -m twine upload --verbose dist/*
